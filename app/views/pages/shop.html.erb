<% content_for :title, "Shop â€¢ Reboot" %>
<% content_for :page, "shop" %>

<%= render "shared/navbar" %>

<main class="container">
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
    <h1 class="page-title" style="margin: 0;">Shop</h1>
    <a href="/purchases" class="btn btn--secondary">Recent Purchases</a>
  </div>

  <div class="shop-layout">
    <aside class="shop-categories card">
      <h3 class="shop-heading">Category</h3>
      <ul class="shop-category-list">
        <% categories = [ "Keyboard", "Mouse", "Monitor", "Headphones", "Webcam" ] %>
        <% categories.each_with_index do |cat, idx| %>
          <li>
            <button class="shop-category-item <%= 'is-active' if idx == 0 %>" data-target="cat-<%= cat.downcase %>">
              <%= cat %>
            </button>
          </li>
        <% end %>
      </ul>
    </aside>

    <section class="shop-items card">
      <div class="shop-items__header">
        <h2 class="shop-heading" style="margin: 0;">Items</h2>
        <div aria-hidden="true" class="shop-cart">
          <img src="https://files.slack.com/files-pri/T09V59WQY1E-F0A793FGJ2V/bolt.png?pub_secret=7acc4044c5" alt="bolts" class="bolt-icon">
        </div>
      </div>

      <% categories.each_with_index do |cat, idx| %>
        <% item = @shop_items.find { |i| i.name.to_s.downcase.strip == cat.downcase } %>
        <% base_cost = (item&.cost || 0).to_i %>
        <div id="cat-<%= cat.downcase %>" class="shop-item-detail <%= 'is-active' if idx == 0 %>">
          <div class="shop-item-detail__variants">
            <% variants = [
              ['Standard grant', 'standard'],
              ['Quality grant', 'quality'],
              ['Advanced grant', 'advanced'],
              ['Professional grant', 'professional']
            ] %>
            <% images_for_keyboard = [
              'https://files.slack.com/files-pri/T09V59WQY1E-F0A6SJ1AQAH/vecteezy_keyboard-3d-rendering-icon-illustration_28606613.png?pub_secret=9418a400cb',
              'https://files.slack.com/files-pri/T09V59WQY1E-F0A6SHUUGN9/vecteezy_gaming-keyboard-with-anti-ghosting-technology-transparent_57571865.png?pub_secret=2fe417ad9b',
              'https://files.slack.com/files-pri/T09V59WQY1E-F0A7QABPARW/vecteezy_rgb-illuminated-white-gaming-keyboard-top-view_52855142.png?pub_secret=3d3c0544c6',
              'https://files.slack.com/files-pri/T09V59WQY1E-F0A6EHQKAUF/vecteezy_white-rgb-mechanical-gaming-keyboard-with-cable_52855199.png?pub_secret=3e689005bb'
            ] if cat == 'Keyboard' %>
            <% images_for_mouse = [
              'https://files.slack.com/files-pri/T09V59WQY1E-F0A7QDJR56C/vecteezy_computer-mouse-isolated-on-a-transparent-background_47833235.png?pub_secret=206f7975e4',
              'https://files.slack.com/files-pri/T09V59WQY1E-F0A6PNNB8HH/vecteezy_ai-generated-computer-mouse-png-isolated-on-transparent_36113136.png?pub_secret=5328baa9cd',
              'https://files.slack.com/files-pri/T09V59WQY1E-F0A6ZMVP5RA/vecteezy_ai-generated-computer-mouse-png-isolated-on-transparent_36112700.png?pub_secret=4a6941278c',
              'https://files.slack.com/files-pri/T09V59WQY1E-F0A6ELUDWQP/vecteezy_ai-generated-computer-mouse-png-isolated-on-transparent_36112693.png?pub_secret=8a1b07b884'
            ] if cat == 'Mouse' %>
            <% images_for_monitor = [
              'https://files.slack.com/files-pri/T09V59WQY1E-F0A793DR88Z/10740609.png?pub_secret=edffb80446',
              'https://files.slack.com/files-pri/T09V59WQY1E-F0A6ZNZN99A/3d-monitor-curved-free-png.webp?pub_secret=9d8649f57c',
              'https://files.slack.com/files-pri/T09V59WQY1E-F0A6W5FN41Y/vecteezy_3d-monitor-for-office_53739745.png?pub_secret=6a16537f48',
              'https://files.slack.com/files-pri/T09V59WQY1E-F0A6EN1NVP1/vecteezy_sleek-black-computer-monitor-with-vibrant-red-abstract_56609224.png?pub_secret=5e30e2cd74'
            ] if cat == 'Monitor' %>
            <% variants.each_with_index do |(label_text, key), variant_idx| %>
              <% price = 0 %>
              <% img_src = (
                (cat == 'Keyboard' && images_for_keyboard && images_for_keyboard[variant_idx]) ||
                (cat == 'Mouse' && images_for_mouse && images_for_mouse[variant_idx]) ||
                (cat == 'Monitor' && images_for_monitor && images_for_monitor[variant_idx]) ||
                '/images/signin/hackclub.svg'
              ) %>
              <div class="shop-variant">
                <div class="shop-variant__thumb">
                  <img src="<%= img_src %>" alt="<%= label_text %>">
                </div>

                <div class="shop-variant__name"><%= label_text %></div>

                <div class="shop-variant__meta">
                  <button type="button"
                          class="shop-variant__priceBox price-btn"
                          data-item-id="<%= item&.id %>"
                          data-name="<%= cat %>"
                          data-variant="<%= key %>"
                          data-display="<%= label_text %>"
                          data-price="<%= price %>"
                          data-img="<%= img_src %>"
                          data-desc="<%= (item&.description || 'No description available.').to_s.gsub('\"','&quot;') %>">
                    <span class="shop-variant__price"><%= price %></span>
                    <img src="https://files.slack.com/files-pri/T09V59WQY1E-F0A793FGJ2V/bolt.png?pub_secret=7acc4044c5" alt="bolts" class="bolt-icon">
                  </button>
                  <span class="shop-variant__pill shop-variant__pill--<%= key %>"><%= label_text %></span>
                </div>

                <!-- Purchase action moved to modal -->
              </div>
            <% end %>
          </div>
        </div>
      <% end %>
    </section>
  </div>
</main>

<!-- Item Modal -->
<div id="shop-item-modal" class="modal modal--hidden" data-user-balance="<%= @current_user.balance.to_i %>">
  <div class="modal__backdrop"></div>
  <div class="modal__content card">
    <div class="modal__header">
      <h3 id="shop-modal-title" class="modal__title">Item</h3>
      <button type="button" class="modal__close" aria-label="Close">&times;</button>
    </div>
    <div class="shop-modal__body">
      <img id="shop-modal-image" class="shop-modal__image" src="/images/signin/hackclub.svg" alt="item">
      <p id="shop-modal-desc" class="shop-modal__desc muted">Description</p>
      <div class="shop-modal__price">
        <span id="shop-modal-price">0</span>
        <img src="https://files.slack.com/files-pri/T09V59WQY1E-F0A793FGJ2V/bolt.png?pub_secret=7acc4044c5" alt="bolts" class="bolt-icon">
      </div>
      <%= form_with url: purchase_path, method: :post, local: true, id: "shop-modal-form" do %>
        <input type="hidden" name="item_id" id="shop-modal-item-id" value="">
        <input type="hidden" name="variant" id="shop-modal-variant" value="">
        <button id="shop-modal-buy" type="submit" class="btn btn--primary btn--block">Purchase</button>
      <% end %>
    </div>
  </div>
  <style>
    .shop-modal__body { display: grid; gap: 12px; }
    .shop-modal__image { width: 100%; height: 180px; border-radius: 10px; object-fit: cover; background: var(--paper-alt); }
    .shop-modal__price { display: inline-flex; align-items: center; gap: 8px; background: #efd1a4; padding: 8px 12px; border-radius: 12px; width: fit-content; }
  </style>
</div>
